name: Code Quality Check

# è§¦å‘æ¡ä»¶
on:
  # æ¨é€åˆ°ä¸»åˆ†æ”¯
  push:
    branches: [ main, master ]
  
  # Pull Request åˆ°ä¸»åˆ†æ”¯
  pull_request:
    branches: [ main, master ]
  
  # æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

# å¹¶å‘æ§åˆ¶ï¼šå–æ¶ˆåŒä¸€åˆ†æ”¯çš„æ—§æ„å»º
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  code-quality:
    name: ä»£ç è´¨é‡æ£€æŸ¥
    runs-on: ubuntu-latest
    
    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
    
    # 2. å®‰è£… uv
    - name: å®‰è£… uv
      uses: astral-sh/setup-uv@v3
      with:
        version: "latest"
        enable-cache: true
    
    # 3. è®¾ç½® Python ç‰ˆæœ¬
    - name: è®¾ç½® Python ç‰ˆæœ¬
      run: uv python install 3.12
    
    # 4. å®‰è£…é¡¹ç›®ä¾èµ–
    - name: å®‰è£…ä¾èµ–
      run: |
        uv sync --dev
        uv add --dev ruff
    
    # 5. æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
    - name: æ˜¾ç¤ºç¯å¢ƒä¿¡æ¯
      run: |
        echo "ğŸ”§ ç¯å¢ƒä¿¡æ¯ï¼š"
        uv --version
        uv run python --version
        uv run ruff --version
    
    # 6. è¿è¡Œ ruff ä»£ç æ£€æŸ¥
    - name: Ruff ä»£ç è´¨é‡æ£€æŸ¥
      run: |
        echo "ğŸ” å¼€å§‹ä»£ç è´¨é‡æ£€æŸ¥..."
        uv run ruff check . --output-format=github
      continue-on-error: false
    
    # 7. è¿è¡Œ ruff æ ¼å¼æ£€æŸ¥
    - name: Ruff ä»£ç æ ¼å¼æ£€æŸ¥
      run: |
        echo "ğŸ“ æ£€æŸ¥ä»£ç æ ¼å¼..."
        uv run ruff format . --check --diff
      continue-on-error: false
    
    # 8. ä»£ç ç»Ÿè®¡ä¿¡æ¯
    - name: ä»£ç ç»Ÿè®¡ä¿¡æ¯
      if: always()
      run: |
        echo "ğŸ“Š ä»£ç ç»Ÿè®¡ä¿¡æ¯ï¼š"
        echo "----------------------------------------"
        python_files=$(find . -name "*.py" -not -path "./.venv/*" -not -path "./__pycache__/*" | wc -l)
        total_lines=$(find . -name "*.py" -not -path "./.venv/*" -not -path "./__pycache__/*" -exec cat {} \; | wc -l)
        echo "Python æ–‡ä»¶æ•°é‡: $python_files"
        echo "æ€»ä»£ç è¡Œæ•°: $total_lines"
        echo "----------------------------------------"
    
    # 9. æ£€æŸ¥ç»“æœæ€»ç»“
    - name: æ£€æŸ¥ç»“æœ
      if: always()
      run: |
        echo "âœ… ä»£ç è´¨é‡æ£€æŸ¥å®Œæˆï¼"
        echo "å¦‚æœæ‰€æœ‰æ£€æŸ¥éƒ½é€šè¿‡ï¼Œè¯´æ˜ä»£ç ç¬¦åˆé¡¹ç›®è´¨é‡æ ‡å‡†ã€‚"
